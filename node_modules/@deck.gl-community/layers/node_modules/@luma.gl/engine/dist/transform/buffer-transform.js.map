{"version":3,"file":"buffer-transform.js","names":["Buffer","assert","getPassthroughFS","Model","BufferTransform","isSupported","device","features","has","constructor","props","arguments","length","undefined","defaultProps","model","transformFeedback","id","fs","version","topology","createTransformFeedback","layout","pipeline","shaderLayout","buffers","feedbackBuffers","setTransformFeedback","Object","seal","destroy","delete","run","options","renderPass","beginRenderPass","draw","end","update","console","warn","getBuffer","varyingName","readAsync","result","buffer","byteOffset","byteLength"],"sources":["../../src/transform/buffer-transform.ts"],"sourcesContent":["// luma.gl, MIT license\n// Copyright (c) vis.gl contributors\n\nimport {Device, Buffer, BufferRange, TransformFeedback, assert, RenderPassProps} from '@luma.gl/core';\nimport {getPassthroughFS} from '@luma.gl/shadertools';\nimport {Model} from '../model/model';\nimport type { ModelProps } from '..';\n\n/**\n * Properties for creating a {@link BufferTransform}\n * @deprecated\n */\nexport type BufferTransformProps = Omit<ModelProps, 'fs'> & {\n  fs?: ModelProps['fs']; // override as optional\n  feedbackBuffers?: Record<string, Buffer | BufferRange>;\n};\n\n/**\n * Creates a pipeline for bufferâ†’buffer transforms.\n * @deprecated\n */\nexport class BufferTransform {\n  readonly device: Device;\n  readonly model: Model;\n  readonly transformFeedback: TransformFeedback;\n\n  /** @deprecated Use device feature test. */\n  static isSupported(device: Device): boolean {\n    return device.features.has('transform-feedback-webgl2');\n  }\n\n  constructor(device: Device, props: BufferTransformProps = Model.defaultProps) {\n    assert(device.features.has('transform-feedback-webgl2'), 'Device must support transform feedback');\n\n    this.device = device;\n\n    this.model = new Model(this.device, {\n      id: props.id || 'buffer-transform-model',\n      fs: props.fs || getPassthroughFS({version: 300}),\n      topology: props.topology || 'point-list',\n      ...props,\n    });\n\n    this.transformFeedback = this.device.createTransformFeedback({\n      layout: this.model.pipeline.shaderLayout,\n      buffers: props.feedbackBuffers,\n    });\n\n    this.model.setTransformFeedback(this.transformFeedback);\n\n    Object.seal(this);\n  }\n\n  /** Destroy owned resources. */\n  destroy(): void {\n    if (this.model) {\n      this.model.destroy();\n    }\n  }\n\n  /** @deprecated Use {@link destroy}. */\n  delete(): void {\n    this.destroy();\n  }\n\n  /** Run one transform loop. */\n  run(options?: RenderPassProps): void {\n    const renderPass = this.device.beginRenderPass(options);\n    this.model.draw(renderPass);\n    renderPass.end();\n  }\n\n  /** @deprecated */\n  update(...args: any[]): void {\n    // TODO(v9): Method should likely be removed for v9. Keeping a method stub\n    // to assist with migrating DeckGL usage.\n    // eslint-disable-next-line no-console\n    console.warn('TextureTransform#update() not implemented');\n  }\n\n  /** Returns the {@link Buffer} or {@link BufferRange} for given varying name. */\n  getBuffer(varyingName: string): Buffer | BufferRange | null {\n    return this.transformFeedback.getBuffer(varyingName);\n  }\n\n  readAsync(varyingName: string): Promise<Uint8Array> {\n    const result = this.getBuffer(varyingName);\n    if (result instanceof Buffer) {\n      return result.readAsync();\n    }\n    const {buffer, byteOffset = 0, byteLength = buffer.byteLength} = result;\n    return buffer.readAsync(byteOffset, byteLength);\n  }\n}\n"],"mappings":"AAGA,SAAgBA,MAAM,EAAkCC,MAAM,QAAwB,eAAe;AACrG,SAAQC,gBAAgB,QAAO,sBAAsB;AAAC,SAC9CC,KAAK;AAgBb,OAAO,MAAMC,eAAe,CAAC;EAM3B,OAAOC,WAAWA,CAACC,MAAc,EAAW;IAC1C,OAAOA,MAAM,CAACC,QAAQ,CAACC,GAAG,CAAC,2BAA2B,CAAC;EACzD;EAEAC,WAAWA,CAACH,MAAc,EAAoD;IAAA,IAAlDI,KAA2B,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAGR,KAAK,CAACW,YAAY;IAAA,KATnER,MAAM;IAAA,KACNS,KAAK;IAAA,KACLC,iBAAiB;IAQxBf,MAAM,CAACK,MAAM,CAACC,QAAQ,CAACC,GAAG,CAAC,2BAA2B,CAAC,EAAE,wCAAwC,CAAC;IAElG,IAAI,CAACF,MAAM,GAAGA,MAAM;IAEpB,IAAI,CAACS,KAAK,GAAG,IAAIZ,KAAK,CAAC,IAAI,CAACG,MAAM,EAAE;MAClCW,EAAE,EAAEP,KAAK,CAACO,EAAE,IAAI,wBAAwB;MACxCC,EAAE,EAAER,KAAK,CAACQ,EAAE,IAAIhB,gBAAgB,CAAC;QAACiB,OAAO,EAAE;MAAG,CAAC,CAAC;MAChDC,QAAQ,EAAEV,KAAK,CAACU,QAAQ,IAAI,YAAY;MACxC,GAAGV;IACL,CAAC,CAAC;IAEF,IAAI,CAACM,iBAAiB,GAAG,IAAI,CAACV,MAAM,CAACe,uBAAuB,CAAC;MAC3DC,MAAM,EAAE,IAAI,CAACP,KAAK,CAACQ,QAAQ,CAACC,YAAY;MACxCC,OAAO,EAAEf,KAAK,CAACgB;IACjB,CAAC,CAAC;IAEF,IAAI,CAACX,KAAK,CAACY,oBAAoB,CAAC,IAAI,CAACX,iBAAiB,CAAC;IAEvDY,MAAM,CAACC,IAAI,CAAC,IAAI,CAAC;EACnB;EAGAC,OAAOA,CAAA,EAAS;IACd,IAAI,IAAI,CAACf,KAAK,EAAE;MACd,IAAI,CAACA,KAAK,CAACe,OAAO,CAAC,CAAC;IACtB;EACF;EAGAC,MAAMA,CAAA,EAAS;IACb,IAAI,CAACD,OAAO,CAAC,CAAC;EAChB;EAGAE,GAAGA,CAACC,OAAyB,EAAQ;IACnC,MAAMC,UAAU,GAAG,IAAI,CAAC5B,MAAM,CAAC6B,eAAe,CAACF,OAAO,CAAC;IACvD,IAAI,CAAClB,KAAK,CAACqB,IAAI,CAACF,UAAU,CAAC;IAC3BA,UAAU,CAACG,GAAG,CAAC,CAAC;EAClB;EAGAC,MAAMA,CAAA,EAAuB;IAI3BC,OAAO,CAACC,IAAI,CAAC,2CAA2C,CAAC;EAC3D;EAGAC,SAASA,CAACC,WAAmB,EAA+B;IAC1D,OAAO,IAAI,CAAC1B,iBAAiB,CAACyB,SAAS,CAACC,WAAW,CAAC;EACtD;EAEAC,SAASA,CAACD,WAAmB,EAAuB;IAClD,MAAME,MAAM,GAAG,IAAI,CAACH,SAAS,CAACC,WAAW,CAAC;IAC1C,IAAIE,MAAM,YAAY5C,MAAM,EAAE;MAC5B,OAAO4C,MAAM,CAACD,SAAS,CAAC,CAAC;IAC3B;IACA,MAAM;MAACE,MAAM;MAAEC,UAAU,GAAG,CAAC;MAAEC,UAAU,GAAGF,MAAM,CAACE;IAAU,CAAC,GAAGH,MAAM;IACvE,OAAOC,MAAM,CAACF,SAAS,CAACG,UAAU,EAAEC,UAAU,CAAC;EACjD;AACF"}