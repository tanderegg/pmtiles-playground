{"version":3,"file":"group-node.js","names":["Matrix4","Vector3","log","ScenegraphNode","GroupNode","constructor","props","arguments","length","undefined","Array","isArray","children","assert","every","child","getBounds","result","Infinity","traverse","node","_ref","worldMatrix","bounds","min","max","center","add","divide","transformAsPoint","halfSize","subtract","transformAsVector","v","position","multiply","i","Math","Number","isFinite","destroy","forEach","removeAll","_len","_key","push","remove","indexOf","splice","visitor","modelMatrix","multiplyRight","matrix"],"sources":["../../src/scenegraph/group-node.ts"],"sourcesContent":["import {Matrix4, Vector3} from '@math.gl/core';\nimport {log} from '@luma.gl/core';\nimport {ScenegraphNode, ScenegraphNodeProps} from './scenegraph-node';\n\nexport type GroupNodeProps = ScenegraphNodeProps & {\n  children?: ScenegraphNode[];\n}\n\nexport class GroupNode extends ScenegraphNode {\n  children: ScenegraphNode[];\n\n  constructor(children: ScenegraphNode[]);\n  constructor(props?: GroupNodeProps);\n\n  constructor(props: ScenegraphNode[] | GroupNodeProps = {}) {\n    props = Array.isArray(props) ? {children: props} : props;\n    const {children = []} = props;\n    log.assert(\n      children.every((child) => child instanceof ScenegraphNode),\n      'every child must an instance of ScenegraphNode'\n    );\n    super(props);\n    this.children = children;\n  }\n\n  override getBounds(): [number[], number[]] | null {\n    const result: [number[], number[]] = [[Infinity, Infinity, Infinity], [-Infinity, -Infinity, -Infinity]];\n\n    this.traverse((node, {worldMatrix}) => {\n      const bounds = node.getBounds();\n      if (!bounds) {\n        return;\n      }\n      const [min, max] = bounds;\n      const center = new Vector3(min).add(max).divide([2, 2, 2]);\n      worldMatrix.transformAsPoint(center, center);\n      const halfSize = new Vector3(max).subtract(min).divide([2, 2, 2]);\n      worldMatrix.transformAsVector(halfSize, halfSize);\n\n      for (let v = 0; v < 8; v++) {\n        // Test all 8 corners of the box\n        const position = new Vector3(\n          v & 0b001 ? -1 : 1,\n          v & 0b010 ? -1 : 1,\n          v & 0b100 ? -1 : 1\n        ).multiply(halfSize).add(center);\n\n        for (let i = 0; i < 3; i++) {\n          result[0][i] = Math.min(result[0][i], position[i]);\n          result[1][i] = Math.max(result[1][i], position[i]);\n        }\n      }\n    });\n    if (!Number.isFinite(result[0][0])) {\n      return null;\n    }\n    return result;\n  }\n\n  override destroy(): void {\n    this.children.forEach((child) => child.destroy());\n    this.removeAll();\n    super.destroy();\n  }\n\n  // Unpacks arrays and nested arrays of children\n  add(...children: (ScenegraphNode | ScenegraphNode[])[]): this {\n    for (const child of children) {\n      if (Array.isArray(child)) {\n        this.add(...child);\n      } else {\n        this.children.push(child);\n      }\n    }\n    return this;\n  }\n\n  remove(child: ScenegraphNode): this {\n    const children = this.children;\n    const indexOf = children.indexOf(child);\n    if (indexOf > -1) {\n      children.splice(indexOf, 1);\n    }\n    return this;\n  }\n\n  removeAll(): this {\n    this.children = [];\n    return this;\n  }\n\n  traverse(visitor: (node: ScenegraphNode, context: {worldMatrix: Matrix4}) => void, {worldMatrix = new Matrix4()} = {}) {\n    const modelMatrix = new Matrix4(worldMatrix).multiplyRight(this.matrix);\n\n    for (const child of this.children) {\n      if (child instanceof GroupNode) {\n        child.traverse(visitor, {worldMatrix: modelMatrix});\n      } else {\n        visitor(child, {worldMatrix: modelMatrix});\n      }\n    }\n  }\n}\n"],"mappings":"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"}