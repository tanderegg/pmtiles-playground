{"version":3,"file":"get-shader-layout-wgsl.js","names":["WgslReflect","getShaderLayoutFromWGSL","source","shaderLayout","attributes","bindings","parsedWGSL","parseWGSL","uniform","uniforms","members","member","type","push","name","getType","location","binding","group","vertex","entry","attributeCount","inputs","length","i","wgslAttribute","locationType","format","error","Error","message","token","line","cause"],"sources":["../../../src/lib/wgsl/get-shader-layout-wgsl.ts"],"sourcesContent":["// luma.gl, MIT license\n// Copyright (c) vis.gl contributors\n\nimport {ShaderAttributeType, ShaderLayout} from '@luma.gl/core';\nimport {WgslReflect} from '../../libs/wgsl-reflect/wgsl_reflect.module.js';\n\n/**\n * Parse a ShaderLayout from WGSL shader source code.\n * @param source WGSL source code (can contain both @vertex and @fragment entry points)\n * @returns \n */\nexport function getShaderLayoutFromWGSL(source: string): ShaderLayout {\n\n  const shaderLayout: ShaderLayout = {attributes: [], bindings: []};\n\n  const parsedWGSL = parseWGSL(source);\n\n  for (const uniform of parsedWGSL.uniforms) {\n    const members = [];\n    for (const member of uniform.type.members) {\n      members.push({\n        name: member.name,\n        type: getType(member.type)\n      });\n    }\n\n    shaderLayout.bindings.push({\n      type: 'uniform',\n      name: uniform.name,\n      location: uniform.binding,\n      // @ts-expect-error\n      group: uniform.group,\n      members\n    });\n  }\n\n  const vertex = parsedWGSL.entry.vertex[0]; // \"main\"\n\n  // Vertex shader inputs\n  const attributeCount = vertex.inputs.length; // inputs to \"main\"\n  for (let i = 0; i < attributeCount; i++) {\n    const wgslAttribute = vertex.inputs[i];\n\n    // locationType can be \"builtin\"\n    if (wgslAttribute.locationType === 'location') {\n      const type = getType(wgslAttribute.type);\n\n      shaderLayout.attributes.push({\n        name: wgslAttribute.name,\n        location: wgslAttribute.location,\n        type\n      });\n    }\n  }\n  return shaderLayout;\n}\n\n/** Get a valid shader attribute type string from a wgsl-reflect type */\nfunction getType(type: any): ShaderAttributeType {\n  return type.format ? `${type.name}<${type.format.name}>` : type.name;\n}\n\nfunction parseWGSL(source: string): WgslReflect {\n  try {\n    return new WgslReflect(source);\n  } catch (error: any) {\n    if (error instanceof Error) {\n      throw error;\n    }\n    let message = 'WGSL parse error';\n    if (typeof error === 'object' && error?.message) {\n      message += `: ${error.message} `;\n    }\n    if (typeof error === 'object' && error?.token) {\n      message += error.token.line || '';\n    }\n    throw new Error(message, {cause: error});\n  }\n}\n"],"mappings":"AAIA,SAAQA,WAAW,QAAO,gDAAgD;AAO1E,OAAO,SAASC,uBAAuBA,CAACC,MAAc,EAAgB;EAEpE,MAAMC,YAA0B,GAAG;IAACC,UAAU,EAAE,EAAE;IAAEC,QAAQ,EAAE;EAAE,CAAC;EAEjE,MAAMC,UAAU,GAAGC,SAAS,CAACL,MAAM,CAAC;EAEpC,KAAK,MAAMM,OAAO,IAAIF,UAAU,CAACG,QAAQ,EAAE;IACzC,MAAMC,OAAO,GAAG,EAAE;IAClB,KAAK,MAAMC,MAAM,IAAIH,OAAO,CAACI,IAAI,CAACF,OAAO,EAAE;MACzCA,OAAO,CAACG,IAAI,CAAC;QACXC,IAAI,EAAEH,MAAM,CAACG,IAAI;QACjBF,IAAI,EAAEG,OAAO,CAACJ,MAAM,CAACC,IAAI;MAC3B,CAAC,CAAC;IACJ;IAEAT,YAAY,CAACE,QAAQ,CAACQ,IAAI,CAAC;MACzBD,IAAI,EAAE,SAAS;MACfE,IAAI,EAAEN,OAAO,CAACM,IAAI;MAClBE,QAAQ,EAAER,OAAO,CAACS,OAAO;MAEzBC,KAAK,EAAEV,OAAO,CAACU,KAAK;MACpBR;IACF,CAAC,CAAC;EACJ;EAEA,MAAMS,MAAM,GAAGb,UAAU,CAACc,KAAK,CAACD,MAAM,CAAC,CAAC,CAAC;EAGzC,MAAME,cAAc,GAAGF,MAAM,CAACG,MAAM,CAACC,MAAM;EAC3C,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGH,cAAc,EAAEG,CAAC,EAAE,EAAE;IACvC,MAAMC,aAAa,GAAGN,MAAM,CAACG,MAAM,CAACE,CAAC,CAAC;IAGtC,IAAIC,aAAa,CAACC,YAAY,KAAK,UAAU,EAAE;MAC7C,MAAMd,IAAI,GAAGG,OAAO,CAACU,aAAa,CAACb,IAAI,CAAC;MAExCT,YAAY,CAACC,UAAU,CAACS,IAAI,CAAC;QAC3BC,IAAI,EAAEW,aAAa,CAACX,IAAI;QACxBE,QAAQ,EAAES,aAAa,CAACT,QAAQ;QAChCJ;MACF,CAAC,CAAC;IACJ;EACF;EACA,OAAOT,YAAY;AACrB;AAGA,SAASY,OAAOA,CAACH,IAAS,EAAuB;EAC/C,OAAOA,IAAI,CAACe,MAAM,GAAI,GAAEf,IAAI,CAACE,IAAK,IAAGF,IAAI,CAACe,MAAM,CAACb,IAAK,GAAE,GAAGF,IAAI,CAACE,IAAI;AACtE;AAEA,SAASP,SAASA,CAACL,MAAc,EAAe;EAC9C,IAAI;IACF,OAAO,IAAIF,WAAW,CAACE,MAAM,CAAC;EAChC,CAAC,CAAC,OAAO0B,KAAU,EAAE;IACnB,IAAIA,KAAK,YAAYC,KAAK,EAAE;MAC1B,MAAMD,KAAK;IACb;IACA,IAAIE,OAAO,GAAG,kBAAkB;IAChC,IAAI,OAAOF,KAAK,KAAK,QAAQ,IAAIA,KAAK,aAALA,KAAK,eAALA,KAAK,CAAEE,OAAO,EAAE;MAC/CA,OAAO,IAAK,KAAIF,KAAK,CAACE,OAAQ,GAAE;IAClC;IACA,IAAI,OAAOF,KAAK,KAAK,QAAQ,IAAIA,KAAK,aAALA,KAAK,eAALA,KAAK,CAAEG,KAAK,EAAE;MAC7CD,OAAO,IAAIF,KAAK,CAACG,KAAK,CAACC,IAAI,IAAI,EAAE;IACnC;IACA,MAAM,IAAIH,KAAK,CAACC,OAAO,EAAE;MAACG,KAAK,EAAEL;IAAK,CAAC,CAAC;EAC1C;AACF"}