{"version":3,"file":"shader-assembler.js","names":["ShaderModuleInstance","assembleShaders","selectShaders","ShaderAssembler","constructor","_hookFunctions","_defaultModules","getDefaultShaderAssembler","defaultShaderAssembler","addDefaultModule","module","find","m","name","push","removeDefaultModule","moduleName","filter","addShaderHook","hook","opts","Object","assign","props","modules","_getModuleList","hookFunctions","options","assembled","platformInfo","appModules","arguments","length","undefined","Array","seen","count","i","len","instantiateModules"],"sources":["../../src/lib/shader-assembler.ts"],"sourcesContent":["// luma.gl, MIT license\n// Copyright (c) vis.gl contributors\n\nimport type {ShaderModule} from './shader-module/shader-module';\nimport {ShaderModuleInstance} from './shader-module/shader-module-instance';\nimport {GetUniformsFunc, assembleShaders} from './shader-assembly/assemble-shaders';\nimport {selectShaders, AssembleShaderProps} from './shader-assembly/select-shaders';\n\n/**\n * A stateful version of `assembleShaders` that can be used to assemble shaders.\n * Supports setting of default modules and hooks.\n */\nexport class ShaderAssembler {\n  /** Default ShaderAssembler instance */\n  static defaultShaderAssembler: ShaderAssembler;\n  /** Hook functions */\n  private readonly _hookFunctions: any[] = [];\n  /** Shader modules */\n  private _defaultModules: ShaderModule[] = [];\n\n  /**\n   * A default shader assembler instance - the natural place to register default modules and hooks\n   * @returns \n   */\n  static getDefaultShaderAssembler(): ShaderAssembler {\n    ShaderAssembler.defaultShaderAssembler = ShaderAssembler.defaultShaderAssembler || new ShaderAssembler();\n    return ShaderAssembler.defaultShaderAssembler;\n  }\n\n  /** \n   * Add a default module that does not have to be provided with every call to assembleShaders() \n   */\n  addDefaultModule(module: ShaderModule): void {\n    if (\n      !this._defaultModules.find(\n        m => m.name === (typeof module === 'string' ? module : module.name)\n      )\n    ) {\n      this._defaultModules.push(module);\n    }\n  }\n\n  /** \n   * Remove a default module\n   */\n  removeDefaultModule(module: ShaderModule): void {\n    const moduleName = typeof module === 'string' ? module : module.name;\n    this._defaultModules = this._defaultModules.filter(m => m.name !== moduleName);\n  }\n\n  /**\n   * Register a shader hook\n   * @param hook \n   * @param opts \n   */\n  addShaderHook(hook: string, opts?: any): void {\n    if (opts) {\n      hook = Object.assign(opts, {hook});\n    }\n    this._hookFunctions.push(hook);\n  }\n\n  /**\n   * Assemble a pair of shaders into a single shader program\n   * @param platformInfo \n   * @param props \n   * @returns \n   */\n  assembleShaders(props: AssembleShaderProps): {\n    vs: string;\n    fs: string;\n    getUniforms: GetUniformsFunc;\n    modules:ShaderModuleInstance[];\n  } {\n    const modules = this._getModuleList(props.modules); // Combine with default modules\n    const hookFunctions = this._hookFunctions; // TODO - combine with default hook functions\n    const options = selectShaders(props);\n    const assembled = assembleShaders({platformInfo: props.platformInfo, ...options, modules, hookFunctions}); \n    return {...assembled, modules};\n  }\n\n  /** \n   * Dedupe and combine with default modules\n   */\n  _getModuleList(appModules: (ShaderModule | ShaderModuleInstance)[] = []): ShaderModuleInstance[] {\n    const modules = new Array<ShaderModule | ShaderModuleInstance>(this._defaultModules.length + appModules.length);\n    const seen: Record<string, boolean> = {};\n    let count = 0;\n\n    for (let i = 0, len = this._defaultModules.length; i < len; ++i) {\n      const module = this._defaultModules[i];\n      const name = module.name;\n      modules[count++] = module;\n      seen[name] = true;\n    }\n\n    for (let i = 0, len = appModules.length; i < len; ++i) {\n      const module = appModules[i];\n      const name = module.name;\n      if (!seen[name]) {\n        modules[count++] = module;\n        seen[name] = true;\n      }\n    }\n\n    modules.length = count;\n\n    return ShaderModuleInstance.instantiateModules(modules);\n  }\n}\n"],"mappings":"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"}