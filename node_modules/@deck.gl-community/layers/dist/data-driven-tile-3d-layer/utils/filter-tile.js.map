{"version":3,"file":"filter-tile.js","names":["I3SAttributeLoader","load","filterTile","tile","filtersByAttribute","_tile$content$userDat","result","isFiltered","id","content","userData","customFilters","_tile$content$userDat4","_tile$content$userDat2","_tile$content$userDat3","originalIndices","undefined","indices","filterTileIndices","tileset","loadOptions","i3s","token","_objectIdAttributeDat","attributeName","length","success","filterAttributeField","fields","find","_ref","name","includes","type","tileFilterAttributeData","loadFeatureAttributeData","header","attributeUrls","attributeStorageInfo","objectIdField","_ref2","objectIdAttributeData","attributeValuesMap","forEach","elem","index","triangles","i","featureIds","value","push","Uint32Array","vertex","attributesStorageInfo","attributeIndex","findIndex","_ref3","objectIdAttributeUrl","getUrlWithToken","attributeType","getAttributeValueType","url","arguments","attribute","hasOwnProperty","_attribute$attributeV","attributeValues","valueType"],"sources":["../../../src/data-driven-tile-3d-layer/utils/filter-tile.ts"],"sourcesContent":["// deck.gl-community\n// SPDX-License-Identifier: MIT\n// Copyright (c) vis.gl contributors\n\nimport {Tile3D} from '@loaders.gl/tiles';\nimport {FiltersByAttribute} from '../data-driven-tile-3d-layer';\nimport {AttributeStorageInfo, I3SAttributeLoader} from '@loaders.gl/i3s';\nimport {load} from '@loaders.gl/core';\nimport {TypedArray} from '@loaders.gl/schema';\n\ntype I3STileAttributes = Record<string, string[] | TypedArray | null>;\n\n/**\n * Filter tile indices by attribute value\n * @param tile - tile to be filtered\n * @param filtersByAttribute - custom filters patameters\n * @returns {Promise<{isFiltered: boolean; id: string}>} Result of the tile filtering - isFiltered: true/false and tile id\n */\nexport const filterTile = async (\n  tile: Tile3D,\n  filtersByAttribute: FiltersByAttribute | null\n): Promise<{isFiltered: boolean; id: string}> => {\n  const result = {isFiltered: false, id: tile.id};\n\n  if (tile.content.userData?.customFilters !== filtersByAttribute) {\n    if (tile.content && filtersByAttribute) {\n      if (tile.content.userData?.originalIndices === undefined) {\n        tile.content.userData = {};\n        //save original indices for filtring cancellation\n        tile.content.userData.originalIndices = tile.content.indices;\n      }\n      tile.content.indices = tile.content.userData?.originalIndices;\n      tile.content.userData.customFilters = filtersByAttribute;\n\n      const {indices} = await filterTileIndices(\n        tile,\n        filtersByAttribute,\n        (tile.tileset.loadOptions as any).i3s.token\n      );\n      // Make sure custom filters is not changed during async filtring execution\n      if (indices && tile.content.userData.customFilters === filtersByAttribute) {\n        tile.content.indices = indices;\n        result.isFiltered = true;\n      }\n    } else if (tile.content && tile.content.userData?.originalIndices !== undefined) {\n      tile.content.indices = tile.content.userData.originalIndices;\n      tile.content.userData.customFilters = null;\n      result.isFiltered = true;\n    }\n  }\n  return result;\n};\n\nasync function filterTileIndices(\n  tile: Tile3D,\n  filtersByAttribute: FiltersByAttribute,\n  token: string\n): Promise<{success: boolean; indices?: Uint32Array}> {\n  if (!filtersByAttribute.attributeName.length) {\n    return {success: false};\n  }\n\n  const filterAttributeField = tile.tileset.tileset.fields.find(\n    ({name}) => name === filtersByAttribute?.attributeName\n  );\n\n  if (\n    !filterAttributeField ||\n    !['esriFieldTypeDouble', 'esriFieldTypeInteger', 'esriFieldTypeSmallInteger'].includes(\n      filterAttributeField.type\n    )\n  ) {\n    return {success: false};\n  }\n\n  const tileFilterAttributeData = await loadFeatureAttributeData(\n    filterAttributeField.name,\n    tile.header.attributeUrls,\n    tile.tileset.tileset.attributeStorageInfo,\n    token\n  );\n  if (!tileFilterAttributeData) {\n    return {success: false};\n  }\n\n  const objectIdField = tile.tileset.tileset.fields.find(({type}) => type === 'esriFieldTypeOID');\n  if (!objectIdField) {\n    return {success: false};\n  }\n\n  const objectIdAttributeData = await loadFeatureAttributeData(\n    objectIdField.name,\n    tile.header.attributeUrls,\n    tile.tileset.tileset.attributeStorageInfo,\n    token\n  );\n  if (!objectIdAttributeData) {\n    return {success: false};\n  }\n\n  const attributeValuesMap = {};\n  objectIdAttributeData[objectIdField.name]?.forEach((elem, index) => {\n    attributeValuesMap[elem] =\n      //@ts-expect-error possible null\n      tileFilterAttributeData[filterAttributeField.name][index];\n  });\n\n  if (!tile.content.indices) {\n    const triangles: number[] = [];\n    for (let i = 0; i < tile.content.featureIds.length; i += 3) {\n      if (attributeValuesMap[tile.content.featureIds[i]] === filtersByAttribute.value) {\n        triangles.push(i);\n      }\n    }\n\n    const indices = new Uint32Array(3 * triangles.length);\n\n    triangles.forEach((vertex, index) => {\n      indices[index * 3] = vertex;\n      indices[index * 3 + 1] = vertex + 1;\n      indices[index * 3 + 2] = vertex + 2;\n    });\n    return {success: true, indices};\n  } else {\n    const triangles: number[] = [];\n    for (let i = 0; i < tile.content.indices.length; i += 3) {\n      if (\n        attributeValuesMap[tile.content.featureIds[tile.content.indices[i]]] ===\n        filtersByAttribute.value\n      ) {\n        triangles.push(i);\n      }\n    }\n\n    const indices = new Uint32Array(3 * triangles.length);\n\n    triangles.forEach((vertex, index) => {\n      indices[index * 3] = tile.content.indices[vertex];\n      indices[index * 3 + 1] = tile.content.indices[vertex + 1];\n      indices[index * 3 + 2] = tile.content.indices[vertex + 2];\n    });\n    return {success: true, indices};\n  }\n}\n\nasync function loadFeatureAttributeData(\n  attributeName: string,\n  attributeUrls: string[],\n  attributesStorageInfo: AttributeStorageInfo[],\n  token?: string\n): Promise<I3STileAttributes | null> {\n  const attributeIndex = attributesStorageInfo.findIndex(({name}) => attributeName === name);\n  if (attributeIndex === -1) {\n    return null;\n  }\n  const objectIdAttributeUrl = getUrlWithToken(attributeUrls[attributeIndex], token);\n  const attributeType = getAttributeValueType(attributesStorageInfo[attributeIndex]);\n  const objectIdAttributeData = await load(objectIdAttributeUrl, I3SAttributeLoader, {\n    attributeName,\n    attributeType\n  });\n\n  return objectIdAttributeData;\n}\n\nfunction getUrlWithToken(url: string, token: string | null = null): string {\n  return token ? `${url}?token=${token}` : url;\n}\n\nfunction getAttributeValueType(attribute: AttributeStorageInfo) {\n  // eslint-disable-next-line no-prototype-builtins\n  if (attribute.hasOwnProperty('objectIds')) {\n    return 'Oid32';\n    // eslint-disable-next-line no-prototype-builtins\n  } else if (attribute.hasOwnProperty('attributeValues')) {\n    return attribute.attributeValues?.valueType;\n  }\n  return '';\n}\n"],"mappings":"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"}