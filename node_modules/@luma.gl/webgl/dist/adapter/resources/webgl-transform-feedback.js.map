{"version":3,"file":"webgl-transform-feedback.js","names":["log","TransformFeedback","WEBGLBuffer","getGLPrimitive","WEBGLTransformFeedback","constructor","device","props","gl2","handle","layout","buffers","unusedBuffers","bindOnUse","_bound","assertWebGL2","createTransformFeedback","setBuffers","Object","seal","destroy","deleteTransformFeedback","begin","topology","arguments","length","undefined","bindTransformFeedback","_bindBuffers","beginTransformFeedback","end","endTransformFeedback","_unbindBuffers","bind","bufferName","setBuffer","locationOrName","bufferOrRange","location","_getVaryingIndex","buffer","byteLength","byteOffset","_getBufferRange","warn","id","_bindBuffer","getBuffer","isIndex","funcOrHandle","value","unbind","Number","varying","varyings","name","bufferIndex","bindBufferBase","index","bindBufferRange","isInteger","test"],"sources":["../../../src/adapter/resources/webgl-transform-feedback.ts"],"sourcesContent":["import type {PrimitiveTopology, ShaderLayout, TransformFeedbackProps} from '@luma.gl/core';\nimport {log, TransformFeedback, Buffer, BufferRange} from '@luma.gl/core';\nimport {GL} from '@luma.gl/constants';\nimport {WebGLDevice} from '../webgl-device';\nimport {WEBGLBuffer} from '../..';\nimport {getGLPrimitive} from '../helpers/webgl-topology-utils';\n\nexport class WEBGLTransformFeedback extends TransformFeedback {\n  readonly device: WebGLDevice;\n  readonly gl2: WebGL2RenderingContext;\n  readonly handle: WebGLTransformFeedback;\n\n  /**\n   * NOTE: The Model already has this information while drawing, but\n   * TransformFeedback currently needs it internally, to look up\n   * varying information outside of a draw() call.\n   */\n  readonly layout: ShaderLayout;\n  buffers: Record<string, BufferRange> = {};\n  unusedBuffers: Record<string, Buffer> = {};\n  /**\n   * Allows us to avoid a Chrome bug where a buffer that is already bound to a\n   * different target cannot be bound to 'TRANSFORM_FEEDBACK_BUFFER' target.\n   * This a major workaround, see: https://github.com/KhronosGroup/WebGL/issues/2346\n   */\n  bindOnUse = true;\n  private _bound: boolean = false;\n\n  constructor(device: WebGLDevice, props: TransformFeedbackProps) {\n    super(device, props);\n\n    device.assertWebGL2();\n    this.device = device;\n    this.gl2 = device.gl2;\n    this.handle = this.props.handle || this.gl2.createTransformFeedback();\n    this.layout = this.props.layout;\n\n    if (props.buffers) {\n      this.setBuffers(props.buffers);\n    }\n\n    Object.seal(this);\n  }\n\n  override destroy(): void {\n    this.gl2.deleteTransformFeedback(this.handle);\n    super.destroy();\n  }\n\n  begin(topology: PrimitiveTopology = 'point-list'): void {\n    this.gl2.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, this.handle);\n    if (this.bindOnUse) {\n      this._bindBuffers();\n    }\n    this.gl2.beginTransformFeedback(getGLPrimitive(topology));\n  }\n\n  end(): void {\n    this.gl2.endTransformFeedback();\n    if (!this.bindOnUse) {\n      this._unbindBuffers();\n    }\n    this.gl2.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, null);\n  }\n\n  // SUBCLASS\n\n  setBuffers(buffers: Record<string, Buffer | BufferRange>): void {\n    this.buffers = {};\n    this.unusedBuffers = {};\n\n    this.bind(() => {\n      for (const bufferName in buffers) {\n        this.setBuffer(bufferName, buffers[bufferName]);\n      }\n    });\n  }\n\n  setBuffer(locationOrName: string | number, bufferOrRange: Buffer | BufferRange): void {\n    const location = this._getVaryingIndex(locationOrName);\n    const {buffer, byteLength, byteOffset} = this._getBufferRange(bufferOrRange);\n\n    if (location < 0) {\n      this.unusedBuffers[locationOrName] = buffer;\n      log.warn(`${this.id} unusedBuffers varying buffer ${locationOrName}`)();\n      return;\n    }\n\n    this.buffers[location] = {buffer, byteLength, byteOffset};\n\n    // Need to avoid chrome bug where buffer that is already bound to a different target\n    // cannot be bound to 'TRANSFORM_FEEDBACK_BUFFER' target.\n    if (!this.bindOnUse) {\n      this._bindBuffer(location, buffer, byteOffset, byteLength);\n    }\n  }\n\n  getBuffer(locationOrName: string | number): Buffer | BufferRange | null {\n    if (isIndex(locationOrName)) {\n      return this.buffers[locationOrName] || null;\n    }\n    const location = this._getVaryingIndex(locationOrName);\n    return location >= 0 ? this.buffers[location] : null;\n  }\n\n  bind(funcOrHandle = this.handle) {\n    if (typeof funcOrHandle !== 'function') {\n      this.gl2.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, funcOrHandle);\n      return this;\n    }\n\n    let value: unknown;\n\n    if (!this._bound) {\n      this.gl2.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, this.handle);\n      this._bound = true;\n      value = funcOrHandle();\n      this._bound = false;\n      this.gl2.bindTransformFeedback(GL.TRANSFORM_FEEDBACK, null);\n    } else {\n      value = funcOrHandle();\n    }\n\n    return value;\n  }\n\n  unbind() {\n    this.bind(null);\n  }\n\n  // PRIVATE METHODS\n\n  /** Extract offsets for bindBufferRange */\n  protected _getBufferRange(\n    bufferOrRange: Buffer | {buffer: Buffer; byteOffset?: number; byteLength?: number}\n  ): Required<BufferRange> {\n    if (bufferOrRange instanceof WEBGLBuffer) {\n      return {buffer: bufferOrRange, byteOffset: 0, byteLength: bufferOrRange.byteLength};\n    }\n\n    // To use bindBufferRange either offset or size must be specified.\n    // @ts-expect-error Must be a BufferRange.\n    const {buffer, byteOffset = 0, byteLength = bufferOrRange.buffer.byteLength} = bufferOrRange;\n    return {buffer, byteOffset, byteLength};\n  }\n\n  protected _getVaryingIndex(locationOrName: string | number): number {\n    if (isIndex(locationOrName)) {\n      return Number(locationOrName);\n    }\n\n    for (const varying of this.layout.varyings) {\n      if (locationOrName === varying.name) {\n        return varying.location;\n      }\n    }\n\n    return -1;\n  }\n\n  /**\n   * Need to avoid chrome bug where buffer that is already bound to a different target\n   * cannot be bound to 'TRANSFORM_FEEDBACK_BUFFER' target.\n   */\n  protected _bindBuffers(): void {\n    for (const bufferIndex in this.buffers) {\n      const {buffer, byteLength, byteOffset} = this._getBufferRange(this.buffers[bufferIndex]);\n      this._bindBuffer(Number(bufferIndex), buffer, byteOffset, byteLength);\n    }\n  }\n\n  protected _unbindBuffers(): void {\n    for (const bufferIndex in this.buffers) {\n      this.gl2.bindBufferBase(GL.TRANSFORM_FEEDBACK_BUFFER, Number(bufferIndex), null);\n    }\n  }\n\n  protected _bindBuffer(\n    index: number,\n    buffer: Buffer,\n    byteOffset = 0,\n    byteLength?: number\n  ): void {\n    const handle = buffer && (buffer as WEBGLBuffer).handle;\n    if (!handle || byteLength === undefined) {\n      this.gl2.bindBufferBase(GL.TRANSFORM_FEEDBACK_BUFFER, index, handle);\n    } else {\n      this.gl2.bindBufferRange(GL.TRANSFORM_FEEDBACK_BUFFER, index, handle, byteOffset, byteLength);\n    }\n  }\n}\n\n/**\n * Returns true if the given value is an integer, or a string that\n * trivially converts to an integer (only numeric characters).\n */\nfunction isIndex(value: string | number): boolean {\n  if (typeof value === 'number') {\n    return Number.isInteger(value);\n  }\n  return /^\\d+$/.test(value);\n}\n"],"mappings":"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"}