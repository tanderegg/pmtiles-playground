{"version":3,"file":"webgl-render-pass.js","names":["RenderPass","withGLParameters","setGLParameters","pushContextState","popContextState","GL_DEPTH_BUFFER_BIT","GL_STENCIL_BUFFER_BIT","GL_COLOR_BUFFER_BIT","GL_COLOR","WEBGLRenderPass","constructor","device","props","glParameters","gl","setParameters","parameters","clear","end","framebuffer","pushDebugGroup","groupLabel","popDebugGroup","insertDebugMarker","markerLabel","arguments","length","undefined","depthReadOnly","depthMask","stencilMask","stencilReadOnly","discard","viewport","slice","depthRange","scissorTest","Boolean","scissorRect","scissor","blendConstant","blendColor","stencilReference","console","warn","clearMask","clearColor","clearDepth","clearStencil","clearColorBuffer","drawBuffer","value","gl2","Int32Array","clearBufferiv","Uint32Array","clearBufferuiv","Float32Array","clearBufferfv"],"sources":["../../../src/adapter/resources/webgl-render-pass.ts"],"sourcesContent":["// luma.gl, MIT license\n// Copyright (c) vis.gl contributors\n\nimport {RenderPass, RenderPassProps, NumberArray, RenderPassParameters} from '@luma.gl/core';\nimport {WebGLDevice} from '../webgl-device';\nimport {GL, GLParameters} from '@luma.gl/constants';\nimport {withGLParameters} from '../../context/state-tracker/with-parameters';\nimport {setGLParameters} from '../../context/parameters/unified-parameter-api';\nimport {pushContextState, popContextState} from '../../context/state-tracker/track-context-state';\n\n// Should collapse during minification\nconst GL_DEPTH_BUFFER_BIT = 0x00000100;\nconst GL_STENCIL_BUFFER_BIT = 0x00000400;\nconst GL_COLOR_BUFFER_BIT = 0x00004000;\n\nconst GL_COLOR = 0x1800;\n\nexport class WEBGLRenderPass extends RenderPass {\n  readonly device: WebGLDevice;\n\n  /** Parameters that should be applied before each draw call */\n  glParameters: GLParameters;\n\n  constructor(device: WebGLDevice, props: RenderPassProps) {\n    super(device, props);\n    this.device = device;\n\n    // TODO - do parameters (scissorRect) affect the clear operation?\n    pushContextState(this.device.gl);\n    this.setParameters(this.props.parameters);\n\n    // Hack - for now WebGL draws in \"immediate mode\" (instead of queueing the operations)...\n    this.clear();\n  }\n\n  end(): void {\n    popContextState(this.device.gl);\n    if (this.props.framebuffer) {\n      setGLParameters(this.device, {framebuffer: null});\n    }\n    // should add commands to CommandEncoder.\n  }\n\n  pushDebugGroup(groupLabel: string): void {}\n  popDebugGroup(): void {}\n  insertDebugMarker(markerLabel: string): void {}\n\n  // writeTimestamp(querySet: GPUQuerySet, queryIndex: number): void;\n\n  // beginOcclusionQuery(queryIndex: number): void;\n  // endOcclusionQuery(): void;\n\n  // executeBundles(bundles: Iterable<GPURenderBundle>): void;\n\n  /**\n   * Maps RenderPass parameters to GL parameters\n   */\n  setParameters(parameters: RenderPassParameters = {}): void {\n    const glParameters: GLParameters = {};\n\n    // Framebuffers are specified using parameters in WebGL\n    if (this.props.framebuffer) {\n      glParameters.framebuffer = this.props.framebuffer;\n    }\n\n    if (this.props.depthReadOnly) {\n      glParameters.depthMask = !this.props.depthReadOnly;\n    }\n\n    glParameters.stencilMask = this.props.stencilReadOnly ? 0 : 1;\n\n    glParameters[GL.RASTERIZER_DISCARD] = this.props.discard;\n\n    // Map the four renderpass parameters to WebGL parameters\n    if (parameters.viewport) {\n      // WebGPU viewports are 6 coordinates (X, Y, Z)\n      if (parameters.viewport.length >= 6) {\n        glParameters.viewport = parameters.viewport.slice(0, 4);\n        glParameters.depthRange = [parameters.viewport[4], parameters.viewport[5]];\n      } else {\n        // WebGL viewports are 4 coordinates (X, Y)\n        glParameters.viewport = parameters.viewport;\n      }\n    }\n    glParameters.scissorTest = Boolean(parameters.scissorRect);\n    if (parameters.scissorRect) {\n      glParameters.scissor = parameters.scissorRect;\n    }\n    if (parameters.blendConstant) {\n      glParameters.blendColor = parameters.blendConstant;\n    }\n    if (parameters.stencilReference) {\n      // eslint-disable-next-line no-console\n      console.warn('RenderPassParameters.stencilReference not yet implemented in WebGL');\n      // parameters.stencilFunc = [func, ref, mask];\n      // Does this work?\n      parameters[GL.STENCIL_REF] = parameters.stencilReference;\n    }\n\n    this.glParameters = glParameters;\n\n    setGLParameters(this.device, glParameters);\n  }\n\n  // Internal\n\n  /**\n   * Optionally clears depth, color and stencil buffers based on parameters\n   */\n  protected clear(): void {\n    const glParameters: GLParameters = {...this.glParameters};\n\n    let clearMask = 0;\n\n    if (this.props.clearColor !== false) {\n      clearMask |= GL_COLOR_BUFFER_BIT;\n      glParameters.clearColor = this.props.clearColor;\n    }\n    if (this.props.clearDepth !== false) {\n      clearMask |= GL_DEPTH_BUFFER_BIT;\n      glParameters.clearDepth = this.props.clearDepth;\n    }\n    if (this.props.clearStencil !== false) {\n      clearMask |= GL_STENCIL_BUFFER_BIT;\n      glParameters.clearStencil = this.props.clearStencil;\n    }\n\n    if (clearMask !== 0) {\n      // Temporarily set any clear \"colors\" and call clear\n      withGLParameters(this.device, glParameters, () => {\n        this.device.gl.clear(clearMask);\n      });\n\n      // TODO - clear multiple color attachments\n      // for (attachment of this.framebuffer.colorAttachments) {\n      //   this.clearColorBuffer  \n      // }\n    }\n  }\n\n  /** \n   * WebGL2 - clear a specific color buffer \n   */\n  protected clearColorBuffer(drawBuffer: number = 0, value: NumberArray = [0, 0, 0, 0]) {\n    withGLParameters(this.device.gl2, {framebuffer: this.props.framebuffer}, () => {\n      // Method selection per OpenGL ES 3 docs\n      switch (value.constructor) {\n        case Int32Array:\n          this.device.gl2.clearBufferiv(GL_COLOR, drawBuffer, value);\n          break;\n        case Uint32Array:\n          this.device.gl2.clearBufferuiv(GL_COLOR, drawBuffer, value);\n          break;\n        case Float32Array:\n        default:\n          this.device.gl2.clearBufferfv(GL_COLOR, drawBuffer, value);\n          break;\n      }\n    });\n  }\n\n  // clearDepthStencil() {\n  // const GL_DEPTH = 0x1801;\n  // const GL_STENCIL = 0x1802;\n  // const GL_DEPTH_STENCIL = 0x84f9;\n\n  //     case GL_DEPTH:\n  //       this.device.gl2.clearBufferfv(GL_DEPTH, 0, [value]);\n  //       break;\n\n  //     case GL_STENCIL:\n  //       this.device.gl2.clearBufferiv(GL_STENCIL, 0, [value]);\n  //       break;\n\n  //     case GL_DEPTH_STENCIL:\n  //       const [depth, stencil] = value;\n  //       this.device.gl2.clearBufferfi(GL_DEPTH_STENCIL, 0, depth, stencil);\n  //       break;\n\n  //     default:\n  //       assert(false, ERR_ARGUMENTS);\n  //   }\n  // });\n}\n\n"],"mappings":"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"}