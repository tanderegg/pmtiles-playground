{"version":3,"file":"device-features.js","names":["isWebGL2","isOldIE","getTextureFeatures","_checkFloat32ColorAttachment","getDeviceFeatures","gl","features","getWebGLFeatures","textureFeature","add","getExtension","Set","feature","Object","keys","WEBGL_FEATURES","isFeatureSupported","featureInfo","webgl1Feature","webgl2Feature","featureDefinition","Boolean","canCompileGLSLExtension","behavior","compiledGLSLExtensions","extensionName","opts","arguments","length","undefined","source","shader","createShader","Error","shaderSource","compileShader","canCompile","getShaderParameter","deleteShader"],"sources":["../../../src/adapter/device-helpers/device-features.ts"],"sourcesContent":["// luma.gl, MIT license\n// Copyright (c) vis.gl contributors\n\n// Feature detection for WebGL\n// Provides a function that enables simple checking of which WebGL features are\n// available in an WebGL1 or WebGL2 environment.\n\nimport {DeviceFeature} from '@luma.gl/core';\nimport {isWebGL2} from '../../context/context/webgl-checks';\nimport {isOldIE} from './is-old-ie';\nimport {getTextureFeatures, _checkFloat32ColorAttachment} from '../converters/texture-formats';\n\n/** Get WebGPU style feature strings */\nexport function getDeviceFeatures(gl: WebGLRenderingContext): Set<DeviceFeature> {\n  const features = getWebGLFeatures(gl);\n\n  // texture features\n  // features.add('texture-compression-bc'); \n  for (const textureFeature of getTextureFeatures(gl)) {\n    features.add(textureFeature);\n  }\n\n  // TODO\n  // features.add('depth-clip-control'); // GPUPrimitiveState.clampDepth\n  // features.add('depth24unorm-stencil8'); // GPUTextureFormat 'depth24unorm-stencil8'.\n  // features.add('depth32float-stencil8'); // GPUTextureFormat 'depth32float-stencil8'.\n  // features.add('timestamp-query'); // GPUQueryType \"timestamp-query\"\n  // \"indirect-first-instance\"\n\n  return features;\n}\n\n/** Extract all WebGL features */\nexport function getWebGLFeatures(gl: WebGLRenderingContext): Set<DeviceFeature> {\n  // Enables EXT_float_blend first: https://developer.mozilla.org/en-US/docs/Web/API/EXT_float_blend\n  gl.getExtension('EXT_color_buffer_float');\n  gl.getExtension('WEBGL_color_buffer_float');\n  gl.getExtension('EXT_float_blend');\n\n  const features = new Set<DeviceFeature>();\n  for (const feature of Object.keys(WEBGL_FEATURES)) {\n    // @ts-expect-error\n    if (isFeatureSupported(gl, feature)) {\n      // @ts-expect-error\n      features.add(feature);\n    }\n  }\n  return features;\n}\n\nfunction isFeatureSupported(gl: WebGLRenderingContext, feature: DeviceFeature): boolean {\n  const featureInfo = WEBGL_FEATURES[feature];\n  if (!featureInfo) {\n    return false;\n  }\n\n  const [webgl1Feature, webgl2Feature] = featureInfo || [];\n\n  // Get extension name from table\n  const featureDefinition = isWebGL2(gl) ? webgl2Feature : webgl1Feature;\n\n  // Check if the value is dependent on checking one or more extensions\n  if (typeof featureDefinition === 'boolean') {\n    return featureDefinition;\n  }\n\n  switch (feature) {\n    case 'texture-renderable-rgba32float-webgl':\n      return isWebGL2(gl) ? Boolean(gl.getExtension(featureDefinition)) :\n        _checkFloat32ColorAttachment(gl);\n    case 'glsl-derivatives':\n      return canCompileGLSLExtension(gl, featureDefinition); // TODO options\n    case 'glsl-frag-data':\n      return canCompileGLSLExtension(gl, featureDefinition, {behavior: 'require'}); // TODO options\n    case 'glsl-frag-depth':\n      return canCompileGLSLExtension(gl, featureDefinition); // TODO options\n    default:\n      return Boolean(gl.getExtension(featureDefinition));\n  }\n}\n\nconst compiledGLSLExtensions: Record<string, boolean> = {};\n\n/*\n * Enables feature detection in IE11 due to a bug where gl.getExtension may return true\n * but fail to compile when the extension is enabled in the shader. Specifically,\n * the OES_standard_derivatives and WEBGL_draw_buffers extensions fails to compile in IE11 even though its included\n * in the list of supported extensions.\n * opts allows user agent to be overridden for testing\n * Inputs :\n *  gl : WebGL context\n *  cap : Key of WEBGL_FEATURES object identifying the extension\n *  opts :\n *   behavior : behavior of extension to be tested, by defualt `enable` is used\n * Returns : true, if shader is compiled successfully, false otherwise\n */\nexport function canCompileGLSLExtension(gl: WebGLRenderingContext, extensionName, opts: {behavior?} = {}) {\n  if (!isOldIE(opts)) {\n    return true;\n  }\n\n  if (extensionName in compiledGLSLExtensions) {\n    return compiledGLSLExtensions[extensionName];\n  }\n\n  const behavior = opts.behavior || 'enable';\n  const source = `#extension GL_${extensionName} : ${behavior}\\nvoid main(void) {}`;\n\n  const shader = gl.createShader(gl.VERTEX_SHADER);\n  if (!shader) {\n    throw new Error('shader');\n  }\n  gl.shaderSource(shader, source);\n  gl.compileShader(shader);\n  const canCompile = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\n  gl.deleteShader(shader);\n  compiledGLSLExtensions[extensionName] = canCompile;\n  return canCompile;\n}\n\n/** Defines luma.gl \"feature\" names and semantics\n * Format: 'feature-name: [WebGL1 support, WebGL2 support] / [WebGL1 and WebGL2 support]', when support is 'string' it is the name of the extension\n */\nconst WEBGL_FEATURES: Partial<Record<DeviceFeature, [boolean | string, boolean | string]>> = {\n  'webgl': [true, true],\n  'webgl2': [false, true],\n\n  'timer-query-webgl': ['EXT_disjoint_timer_query', 'EXT_disjoint_timer_query_webgl2'],\n  'transform-feedback-webgl2': [false, true],\n\n  // WEBGL1 SUPPORT\n  'vertex-array-object-webgl1': ['OES_vertex_array_object', true],\n  'instanced-rendering-webgl1': ['ANGLE_instanced_arrays', true],\n  'multiple-render-targets-webgl1': ['WEBGL_draw_buffers', true],\n  'index-uint32-webgl1': ['OES_element_index_uint', true],\n  'blend-minmax-webgl1': ['EXT_blend_minmax', true],\n  'texture-blend-float-webgl1': ['EXT_float_blend', 'EXT_float_blend'],\n\n  // TEXTURES, RENDERBUFFERS\n  'texture-formats-srgb-webgl1': ['EXT_sRGB', true],\n\n  // TEXTURES\n  'texture-formats-depth-webgl1': ['WEBGL_depth_texture', true],\n  'texture-formats-float32-webgl1': ['OES_texture_float', true],\n  'texture-formats-float16-webgl1': ['OES_texture_half_float', true],\n\n  'texture-filter-linear-float32-webgl': ['OES_texture_float_linear', 'OES_texture_float_linear'],\n  'texture-filter-linear-float16-webgl': ['OES_texture_half_float_linear', 'OES_texture_half_float_linear'],\n  'texture-filter-anisotropic-webgl': ['EXT_texture_filter_anisotropic', 'EXT_texture_filter_anisotropic'],\n\n  // FRAMEBUFFERS, TEXTURES AND RENDERBUFFERS\n  'texture-renderable-rgba32float-webgl': ['WEBGL_color_buffer_float', 'EXT_color_buffer_float'], // Note override check\n  'texture-renderable-float32-webgl': [false, 'EXT_color_buffer_float'],\n  'texture-renderable-float16-webgl': ['EXT_color_buffer_half_float', 'EXT_color_buffer_half_float'],\n\n  // GLSL extensions\n  'glsl-frag-data': ['WEBGL_draw_buffers', true],\n  'glsl-frag-depth': ['EXT_frag_depth', true],\n  'glsl-derivatives': ['OES_standard_derivatives', true],\n  'glsl-texture-lod': ['EXT_shader_texture_lod', true]\n};\n"],"mappings":"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"}