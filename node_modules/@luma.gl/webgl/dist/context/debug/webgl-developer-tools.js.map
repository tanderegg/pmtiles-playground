{"version":3,"file":"webgl-developer-tools.js","names":["log","loadScript","GL","GLEnum","isBrowser","WEBGL_DEBUG_CDN_URL","getContextData","gl","luma","loadWebGLDeveloperTools","globalThis","WebGLDebugUtils","global","module","makeDebugContext","props","arguments","length","undefined","debug","getDebugContext","getRealContext","data","realContext","warn","debugContext","init","glDebug","onGLError","bind","onValidateGLFunc","key","WebGLDebugContext","Object","setPrototypeOf","getPrototypeOf","create","getFunctionString","functionName","functionArgs","Array","from","map","arg","args","glFunctionArgsToString","slice","err","errorMessage","glEnumToString","glName","webgl2","message","error","throwOnError","Error","functionString","level","break","isBreakpoint","every","breakOn","indexOf"],"sources":["../../../src/context/debug/webgl-developer-tools.ts"],"sourcesContent":["// luma.gl, MIT license\n// Copyright (c) vis.gl contributors\n\nimport {log, loadScript} from '@luma.gl/core';\n// Rename constant to prevent inlining. We need the full set of constants for generating debug strings.\nimport {GL as GLEnum} from '@luma.gl/constants';\nimport {isBrowser} from '@probe.gl/env'\n\nconst WEBGL_DEBUG_CDN_URL = 'https://unpkg.com/webgl-debug@2.0.1/index.js';\n\ntype DebugContextProps = {\n  debug?: boolean;\n  throwOnError?: boolean;\n  break?: string[];\n  webgl2?: boolean;\n};\n\n// const DEFAULT_DEBUG_CONTEXT_PROPS: Required<DebugContextProps> = {\n//   debug: true,\n//   throwOnError: false,\n//   break: [],\n//   webgl2: false,\n// }\n\ntype ContextData = {\n  realContext?: WebGLRenderingContext;\n  debugContext?: WebGLRenderingContext;\n}\n\n// Helper to get shared context data\nfunction getContextData(gl: any): ContextData {\n  gl.luma = gl.luma || {};\n  return gl.luma;\n}\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var WebGLDebugUtils: any;\n}\n\n/**\n * Loads Khronos WebGLDeveloperTools from CDN if not already installed \n * const WebGLDebugUtils = require('webgl-debug');\n * @see https://github.com/KhronosGroup/WebGLDeveloperTools\n * @see https://github.com/vorg/webgl-debug\n */\nexport async function loadWebGLDeveloperTools(): Promise<void> {\n  if (isBrowser() && !globalThis.WebGLDebugUtils) {\n    globalThis.global = globalThis.global || globalThis;\n    // @ts-expect-error Developer tools expects global to be set\n    globalThis.global.module = {};\n    await loadScript(WEBGL_DEBUG_CDN_URL);\n  }\n}\n\n// Returns (a potentially new) context with debug instrumentation turned off or on.\n// Note that this actually returns a new context\nexport function makeDebugContext(gl: WebGLRenderingContext, props: DebugContextProps = {}): WebGLRenderingContext | null {\n  // Return null to ensure we don't try to create a context in this case (TODO what case is that?)\n  if (!gl) {\n    return null;\n  }\n\n  return props.debug ? getDebugContext(gl, props) : getRealContext(gl);\n}\n\n// Returns the real context from either of the real/debug contexts\nfunction getRealContext(gl: WebGLRenderingContext): WebGLRenderingContext {\n  const data = getContextData(gl);\n  // If the context has a realContext member, it is a debug context so return the realContext\n  return data.realContext ? data.realContext : gl;\n}\n\n// Returns the debug context from either of the real/debug contexts\nfunction getDebugContext(gl: WebGLRenderingContext, props: DebugContextProps): WebGLRenderingContext {\n  if (!globalThis.WebGLDebugUtils) {\n    log.warn('webgl-debug not loaded')();\n    return gl;\n  }\n\n  const data = getContextData(gl);\n\n  // If this already has a debug context, return it.\n  if (data.debugContext) {\n    return data.debugContext;\n  }\n\n  // Create a new debug context\n  globalThis.WebGLDebugUtils.init({...GLEnum, ...gl});\n  const glDebug = globalThis.WebGLDebugUtils.makeDebugContext(\n    gl,\n    onGLError.bind(null, props),\n    onValidateGLFunc.bind(null, props)\n  );\n\n  // Make sure we have all WebGL2 and extension constants (todo dynamic import to circumvent minification?)\n  for (const key in GLEnum) {\n    if (!(key in glDebug) && typeof GLEnum[key] === 'number') {\n      glDebug[key] = GLEnum[key];\n    }\n  }\n  \n  // Ensure we have a clean prototype on the instrumented object\n  // Note: setPrototypeOf does come with perf warnings, but we already take a bigger perf reduction\n  // by synchronizing the WebGL errors after each WebGL call.\n  class WebGLDebugContext {}\n  Object.setPrototypeOf(glDebug, Object.getPrototypeOf(gl));\n  Object.setPrototypeOf(WebGLDebugContext, glDebug);\n  const debugContext = Object.create(WebGLDebugContext);\n  // Store the debug context\n  data.realContext = gl;\n  data.debugContext = debugContext;\n  debugContext.debug = true;\n\n  // Return it\n  return debugContext;\n}\n\n// DEBUG TRACING\n\nfunction getFunctionString(functionName: string, functionArgs): string {\n  // Cover bug in webgl-debug-tools\n  functionArgs = Array.from(functionArgs).map(arg => arg === undefined ? 'undefined' : arg);\n  let args = globalThis.WebGLDebugUtils.glFunctionArgsToString(functionName, functionArgs);\n  args = `${args.slice(0, 100)}${args.length > 100 ? '...' : ''}`;\n  return `gl.${functionName}(${args})`;\n}\n\nfunction onGLError(props: DebugContextProps, err, functionName: string, args: any[]): void {\n  // Cover bug in webgl-debug-tools\n  args = Array.from(args).map(arg => arg === undefined ? 'undefined' : arg);\n  const errorMessage = globalThis.WebGLDebugUtils.glEnumToString(err);\n  const functionArgs = globalThis.WebGLDebugUtils.glFunctionArgsToString(functionName, args);\n  const glName = props.webgl2 ? 'gl2' : 'gl1';\n  const message = `${errorMessage} in ${glName}.${functionName}(${functionArgs})`;\n  log.error(message)();\n  debugger; // eslint-disable-line\n  if (props.throwOnError) {\n    throw new Error(message);\n  }\n}\n\n// Don't generate function string until it is needed\nfunction onValidateGLFunc(props: DebugContextProps, functionName: string, functionArgs: any[]): void {\n  let functionString: string = '';\n  if (log.level >= 1) {\n    functionString = getFunctionString(functionName, functionArgs);\n    log.log(1, functionString)();\n  }\n\n  // If array of breakpoint strings supplied, check if any of them is contained in current GLEnum function\n  if (props.break && props.break.length > 0) {\n    functionString = functionString || getFunctionString(functionName, functionArgs);\n    const isBreakpoint = props.break.every((breakOn: string) => functionString.indexOf(breakOn) !== -1);\n    if (isBreakpoint) {\n      debugger; // eslint-disable-line\n    }\n  }\n\n  for (const arg of functionArgs) {\n    if (arg === undefined) {\n      functionString = functionString || getFunctionString(functionName, functionArgs);\n      if (props.throwOnError) {\n        throw new Error(`Undefined argument: ${functionString}`);\n      } else {\n        log.error(`Undefined argument: ${functionString}`)();\n        debugger; // eslint-disable-line\n      }\n    }\n  }\n}\n"],"mappings":"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"}